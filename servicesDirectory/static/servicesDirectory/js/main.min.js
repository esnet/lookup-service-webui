function initMap(e){var t=$("#map-canvas").gmap(e);return t}function initTree(e){var t=$("#tree").fancytree({activate:function(e,t){onNodeActivate(t.node)},extensions:["filter"],filter:{mode:"hide"},source:e});return t}function initTreeNodes(){var e=[];for(var t in serviceMap){var i=[];if(serviceMap[t].types)for(var r in serviceMap[t].types){var o=serviceMap[t].types[r].title,s=i[i.push({folder:!0,name:o,title:o,tooltip:o,type:r,visible:!0})-1];s.children=[]}var a=serviceMap[t].title,n=e[e.push({folder:!0,name:a,title:a,tooltip:a,type:t,visible:!0})-1];n.children=i}return e}function initialize(e){recordMap=new RecordMap(e,!0);for(var t=recordMap.getServices(),i=0;i<t.length;i++)addServiceNode(t[i]),addServiceMarker(t[i]);var r=getFilteredRecords(t,"");filteredMap=new RecordMap(r),showCommunities(),updateMap(),updateTree(),updateStatus(),updateHash(),$("#loading").modal("hide"),$(".modal-backdrop").remove(),inputLocks=[]}function addServiceMarker(e){var t=getLatLng(e);if(t){var i=null;markers[t]?i=markers[t]:(i=map.gmap("addMarker",{position:t,icon:defaultMarkerIcon,optimized:!1}).click(function(){onMarkerActivate(this)}).get(0),i.filtered=[],i.services=[],markers[t]=i),i.services.push(e)}}function addServiceNode(e){var t="",i="";hasField(e,"service-type")&&(t=e["service-type"][0]),hasField(e,t+"-type")&&(i=e[t+"-type"][0]);var r=getHostname(e),o=getTitle(e);if(o&&r){o=r!=o?"<b>"+r+"</b> ("+o+")":"<b>"+r+"</b>";for(var s=null,a=null,n=0;n<treeNodes.length;n++)if(treeNodes[n].type==t.toLowerCase()){if(s=treeNodes[n],i)for(var c=0;c<s.children.length;c++)if(s.children[c].type==i){a=s.children[c];break}break}!s&&t&&(s=treeNodes[treeNodes.push({folder:!0,name:t,title:t,tooltip:t,type:t,visible:!0})-1],s.children=[]),!a&&i&&(a=s.children[s.children.push({folder:!0,name:i,title:i,tooltip:i,type:i,visible:!0})-1],a.children=[]);var l={name:r,title:o,tooltip:r,type:"service",visible:!0};l.service=e,i?a.children.push(l):t?s.children.push(l):treeNodes.push(l)}}function onMarkerActivate(e){activeMarker=e,e.services&&showInfoWindow(e)}function onInfoWindowActivate(e){showServiceInfo(e),showHostInfo(e.host),showHash()}function onNodeActivate(e){if(activeNode=e,e.data.service){var t=e.data.service,i=getLatLng(t);i&&markers[i]?onMarkerActivate(markers[i]):map.gmap("closeInfoWindow"),showServiceInfo(t),showHostInfo(t.host),showHash()}}function showServiceInfo(e){if(clearServiceInfo(),e){activeService=e,hasField(e,"service-name")&&$("#service-name").html(e["service-name"][0]);var t=getLinks(getHostnames(e),"http://","/");$("#service-locator").html(t.join("<br>"));var i=getLocationString(e),r=getLatLngString(e);$("#service-location").html(i+'<br><div class="muted">'+r+"</div"),hasField(e,"group-communities")&&$("#service-communities").html(e["group-communities"].sort().join("<br>")),showCustomInfo(e)}}function showCustomInfo(e){var t=getServiceMapping(e);if(t&&t.custom&&t.custom.type){var i=t.custom;if($("#service-custom-header").text(i.title?i.title:"Custom"),"cli"==i.type){var r=getCommandLine(e,i.formats);$("#service-custom").html(r.join("<br>"))}else if("ma"==i.type){var o=getLinks(getAddresses(e));$("#service-custom").html(o.join("<br>"))}$("#service-custom-header").show(),$("#service-custom").parent().show()}else $("#service-custom-header").hide(),$("#service-custom").parent().hide()}function clearServiceInfo(){activeService=null,$("#service-name").empty(),$("#service-location").empty(),$("#service-locator").empty(),$("#service-communities").empty(),$("#service-custom").empty()}function showHostInfo(e){if(clearHostInfo(),e){if(activeHost=e,hasField(e,"host-name")){var t=getLinks(getHostnames(e),"http://","/");$("#host-name").html(t.join("<br>"))}for(var i=getProcessorStrings(e),r=0;r<i.length;r++)$("#host-hardware").append("Processor #"+(r+1)+": "+i[r]+"<br>");var o=getMemoryString(e);if(o&&$("#host-hardware").append("Memory: "+o+"<br>"),e.interfaces)for(var r=0;r<e.interfaces.length;r++){var s=e.interfaces[r],a=getNICSpeedString(s);a&&$("#host-hardware").append("NIC #"+(r+1)+" Speed: "+a+"<br>"),hasField(s,"interface-mtu")&&$("#host-hardware").append("NIC #"+(r+1)+" MTU: "+s["interface-mtu"][0]+"<br>")}var n=getOSString(e);if(n&&$("#host-os").append("Operating System: "+n+"<br>"),hasField(e,"host-os-kernel")&&$("#host-os").append("Kernel: "+e["host-os-kernel"][0]+"<br>"),e.administrators)for(var r=0;r<e.administrators.length;r++){var c=e.administrators[r],l="Contact #"+(r+1)+": ";if(hasField(c,"person-name")&&(l+=c["person-name"]+" "),hasField(c,"person-emails")){var p=getLinks(c["person-emails"],"mailto:");l+="("+p.join()+")"}$("#host-os").append($.trim(l)+"<br>")}hasField(e,"pshost-toolkitversion")&&$("#host-version").html(e["pshost-toolkitversion"][0]),hasField(e,"group-communities")&&$("#host-communities").html(e["group-communities"].sort().join("<br>"))}}function clearHostInfo(){activeHost=null,$("#host-name").empty(),$("#host-hardware").empty(),$("#host-os").empty(),$("#host-version").empty(),$("#host-communities").empty()}function showCommunities(){communities=[];for(var e=filteredMap.getServices(),t=0;t<e.length;t++)hasField(e[t],"group-communities")&&$.merge(communities,e[t]["group-communities"]);communities=communities.sort().unique();for(var i=$("#communities").empty(),t=0;t<communities.length;t++)i.append($("<option>").val(communities[t]).prop("selected",!0).text(communities[t]));filter.communities=communities}function showHash(){var e={};filter.search&&(e.search=filter.search),filter.communities.length!=communities.length&&(e.communities=filter.communities),activeService&&(e.uri=activeService.uri),ignoreHashChanges++,window.location.hash=hashToQuery(e)}function showInfoWindow(e){for(var t=[],i=e.filtered,r=0;r<i.length;r++){var o=i[r],s=null,a="",n="";if(o.host&&(s=o.host,a=getTitle(o.host),n=getHostname(o.host)),a||(a=getTitle(o)),n||(n=getHostname(o)),a&&n){a!=n&&(a+=" ("+n+")");for(var c=null,l=0;l<t.length;l++)t[l].host&&t[l].host==s?c=t[l]:t[l].hostname==n&&(c=t[l]);c?c.services.push(o):(c=t[t.push({title:a,hostname:n})-1],c.host=s,c.services=[o])}}t.sort(function(e,t){return compareHostnames(e.hostname,t.hostname)});for(var p=$("<div>").prop("id","info-window"),m=$("<dl>").prop("id","info-window-content").appendTo(p),u=function(e,t){var i="",r="";return hasField(e,"service-type")&&(i=e["service-type"][0].toLowerCase()),hasField(t,"service-type")&&(r=t["service-type"][0].toLowerCase()),i>r?1:r>i?-1:0},d=function(e){onInfoWindowActivate($(this).data("service")),e.preventDefault()},r=0;r<t.length;r++){var c=t[r];m.append($("<dt>").text(c.title)),c.services.sort(u);for(var l=0;l<c.services.length;l++){var o=c.services[l],h=getServiceTypeTitle(o);m.append($("<dd>").append($("<a>").prop({title:h,href:"#"}).text(h).data("service",o).click(d)))}}map.gmap("openInfoWindow",{content:p.get(0)},e)}function updateCommunities(){var e=inputLocks.push("updateCommunities")-1,t=$("#communities option"),i=t.filter(":selected").map(function(){return $(this).val()}).get();if(i.length==communities.length)resetCommunities();else if(i.length!=filter.communities.length||!i.equals(filter.communities)){var r=getFilteredRecords(recordMap.getServices(),filter.search,!0);filteredMap=new RecordMap(r);for(var o=filteredMap.getServices(),s=[],a=0;a<o.length;a++)for(var n=0;n<i.length;n++)hasField(o[a],"group-communities")&&$.inArray(i[n],o[a]["group-communities"])>=0&&s.push(o[a]);r=getFilteredRecords(s,""),filteredMap=new RecordMap(r),filter.communities=i,showHash(),updateMap(),updateTree(),updateStatus()}inputLocks.splice(e,1)}function resetCommunities(){var e=inputLocks.push("resetCommunities")-1,t=$("#communities option"),i=t.not(":selected");if(filter.communities.length!=communities.length){var r=getFilteredRecords(recordMap.getServices(),filter.search);filteredMap=new RecordMap(r),filter.communities=communities,showHash(),updateMap(),updateTree(),updateStatus()}i.prop("selected",!0),inputLocks.splice(e,1)}function updateHash(){var e=inputLocks.push("updateHash")-1,t=queryToHash(window.location.hash);if(t.search?($("#search").val(t.search),updateSearch()):resetSearch(),t.communities){var i=$("#communities option");i.each(function(e,i){var r=$(i);$.inArray(r.val(),t.communities)>=0?r.prop("selected",!0):r.prop("selected",!1)}),updateCommunities()}else resetCommunities();if(t.uri){for(var r=null,o=recordMap.getServices(),s=0;s<o.length;s++)if(o[s].uri==t.uri){r=o[s];break}if(r){var a=getLatLng(r);a&&markers[a]?onMarkerActivate(markers[a]):map.gmap("closeInfoWindow"),showServiceInfo(r),showHostInfo(r.host),showHash()}}else map.gmap("closeInfoWindow"),clearServiceInfo(),clearHostInfo();inputLocks.splice(e,1)}function updateMap(){map.gmap("closeInfoWindow"),updateMarkers(),zoomToFitMarkers()}function updateMarkers(){activeMarker=null;for(var e in markers){var t=markers[e];t.filtered=[];for(var i=[],r=0;r<t.services.length;r++){var o=t.services[r];$.inArray(o,filteredMap.getServices(o))>=0&&(t.filtered.push(o),i.push(o.host?getTitle(o.host):getTitle(o)))}i=i.sort(compareHostnames).unique(),1==i.length?t.setTitle(i[0]):i.length>1&&t.setTitle(i[0]+"..."),t.setVisible(t.filtered.length>0?!0:!1)}}function updateSearch(){var e=inputLocks.push("updateSearch")-1,t=$("#search").val();if(t!=filter.search){try{var i=getFilteredRecords(recordMap.getServices(),t);filteredMap=new RecordMap(i),filter.search=t}catch(r){return void $("#search-control").addClass("error")}showCommunities(),showHash(),updateMap(),updateTree(),updateStatus()}inputLocks.splice(e,1)}function resetSearch(){var e=inputLocks.push("resetSearch")-1;if(filter.search){var t=getFilteredRecords(recordMap.getServices(),"");filteredMap=new RecordMap(t),filter.search="",showCommunities(),showHash(),updateMap(),updateTree(),updateStatus()}inputLocks.splice(e,1)}function updateStatus(){var e=filteredMap.getHosts().length,t=filteredMap.getServices().length,i=recordMap.getServices().length;$("#status").html(1==e?"Showing: "+t+" of "+i+" services on "+e+" host.":"Showing: "+t+" of "+i+" services on "+e+" hosts.")}function updateTree(){activeNode=null,updateTreeNodes(),tree.fancytree("getTree").reload(),tree.fancytree("getTree").filterNodes(function(e){return e.data.visible}),tree.fancytree("getRootNode").sortChildren(function(e,t){var i=e.isFolder(),r=t.isFolder();return i||r?!i&&r?1:i&&!r?-1:0:compareHostnames(e.data.name,t.data.name)},!0)}function updateTreeNodes(e){e||(e=treeNodes);for(var t=0,i=0;i<e.length;i++){var r=e[i];if(r.folder){var o=updateTreeNodes(r.children);r.title=r.name+'<span class="badge tree-badge">'+o+"</span>",o>0?(r.visible=!0,t+=o):r.visible=!1}else r.service&&($.inArray(r.service,filteredMap.getServices(r.service))>=0?(r.visible=!0,t++):r.visible=!1)}return t}function zoomToFitMarkers(){var e=new google.maps.LatLngBounds;for(var t in markers)markers[t].visible&&e.extend(markers[t].getPosition());e.isEmpty()||map.gmap("get","map").fitBounds(e);var i=map.gmap("get","map").getZoom();i=2>i?2:i>6?6:i,map.gmap("option","zoom",i)}var inputLocks=["init"],ignoreHashChanges=0,recordMap=null,filteredMap=null,communities,filter={search:"",communities:[]},activeService=null,activeHost=null;$("#loading").modal("show");var mapOptions={center:new google.maps.LatLng(0,0),zoom:2,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,noClear:!0},map=initMap(mapOptions),defaultMarkerIcon={path:google.maps.SymbolPath.CIRCLE,scale:4,fillColor:"#EF706C",fillOpacity:1,strokeColor:"#E36C65",strokeWeight:1},markers={},activeMarker=null,treeNodes=initTreeNodes(),tree=initTree(treeNodes),activeNode=null;$(window).on("hashchange",function(){0===inputLocks.length&&0===ignoreHashChanges?updateHash():ignoreHashChanges--}),$("#communities-update").click(function(){0===inputLocks.length&&updateCommunities()}),$("#communities-reset").click(function(){0===inputLocks.length&&resetCommunities()}),$("#search-update").click(function(){0===inputLocks.length&&updateSearch()}),$("#search-reset").click(function(){0===inputLocks.length&&resetSearch()}),$("#search").keydown(function(e){$("#search-control").removeClass("error"),0===inputLocks.length&&13==e.keyCode&&(updateSearch(),e.preventDefault())}),$.getJSON("query?filter=default&geocode=true&remap=true",function(e){initialize(e)});