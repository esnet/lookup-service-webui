function initMap(e){var t=$("#map-canvas").gmap(e);return t}function initTree(e){var t=$("#tree").fancytree({activate:function(e,t){onNodeActivate(t.node)},extensions:["filter"],filter:{mode:"hide"},source:e});return t}function initTreeNodes(){var e=[];for(var t in serviceMap){var r=[];if(serviceMap[t].types)for(var i in serviceMap[t].types){var o=serviceMap[t].types[i].title,a=r[r.push({folder:!0,name:o,title:o,tooltip:o,type:i,visible:!0})-1];a.children=[]}var s=serviceMap[t].title,n=e[e.push({folder:!0,name:s,title:s,tooltip:s,type:t,visible:!0})-1];n.children=r}return e}function initialize(e){recordMap=new RecordMap(e,!0);for(var t=recordMap.getServices(),r=0;r<t.length;r++)addServiceNode(t[r]),addServiceMarker(t[r]);var i=getFilteredRecords(t,"");filteredMap=new RecordMap(i),showCommunities(),updateMap(),updateTree(),updateStatus(),initialized=!0}function addServiceMarker(e){var t=getLatLng(e);if(t){var r=null;markers[t]?r=markers[t]:(r=map.gmap("addMarker",{position:t,icon:defaultMarkerIcon,optimized:!1}).click(function(){onMarkerActivate(this)}).get(0),r.filtered=[],r.services=[],markers[t]=r),r.services.push(e)}}function addServiceNode(e){var t="",r="";hasField(e,"service-type")&&(t=e["service-type"][0]),hasField(e,t+"-type")&&(r=e[t+"-type"][0]);var i=getHostname(e),o=getTitle(e);if(o&&i){o=i!=o?"<b>"+i+"</b> ("+o+")":"<b>"+i+"</b>";for(var a=null,s=null,n=0;n<treeNodes.length;n++)if(treeNodes[n].type==t.toLowerCase()){if(a=treeNodes[n],r)for(var c=0;c<a.children.length;c++)if(a.children[c].type==r){s=a.children[c];break}break}!a&&t&&(a=treeNodes[treeNodes.push({folder:!0,name:t,title:t,tooltip:t,type:t,visible:!0})-1],a.children=[]),!s&&r&&(s=a.children[a.children.push({folder:!0,name:r,title:r,tooltip:r,type:r,visible:!0})-1],s.children=[]);var l={name:i,title:o,tooltip:i,type:"service",visible:!0};l.service=e,r?s.children.push(l):t?a.children.push(l):treeNodes.push(l)}}function onMarkerActivate(e){activeMarker=e,e.services&&showInfoWindow(e)}function onInfoWindowActivate(e){showServiceInfo(e),showHostInfo(e.host)}function onNodeActivate(e){if(activeNode=e,e.data.service){var t=e.data.service,r=getLatLng(t);r&&markers[r]?onMarkerActivate(markers[r]):map.gmap("closeInfoWindow"),showServiceInfo(t),showHostInfo(t.host)}}function showServiceInfo(e){if(clearServiceInfo(),e){activeService=e,hasField(e,"service-name")&&$("#service-name").html(e["service-name"][0]);var t=getLinks(getHostnames(e),"http://","/");$("#service-locator").html(t.join("<br>"));var r=getLocationString(e),i=getLatLngString(e);$("#service-location").html(r+'<br><div class="muted">'+i+"</div"),hasField(e,"group-communities")&&$("#service-communities").html(e["group-communities"].sort().join("<br>")),showCustomInfo(e)}}function showCustomInfo(e){var t=getServiceMapping(e);if(t&&t.custom&&t.custom.type){var r=t.custom;if($("#service-custom-header").text(r.title?r.title:"Custom"),"cli"==r.type){var i=getCommandLine(e,r.format);$("#service-custom").html(i.join("<br>"))}else if("ma"==r.type){var o=getLinks(getAddresses(e));$("#service-custom").html(o.join("<br>"))}$("#service-custom-header").show(),$("#service-custom").parent().show()}else $("#service-custom-header").hide(),$("#service-custom").parent().hide()}function clearServiceInfo(){activeService=null,$("#service-name").empty(),$("#service-location").empty(),$("#service-locator").empty(),$("#service-communities").empty(),$("#service-custom").empty()}function showHostInfo(e){if(clearHostInfo(),e){if(activeHost=e,hasField(e,"host-name")){var t=getLinks(getHostnames(e),"http://","/");$("#host-name").html(t.join("<br>"))}for(var r=getProcessorStrings(e),i=0;i<r.length;i++)$("#host-hardware").append("Processor #"+(i+1)+": "+r[i]+"<br>");var o=getMemoryString(e);if(o&&$("#host-hardware").append("Memory: "+o+"<br>"),e.interfaces)for(var i=0;i<e.interfaces.length;i++){var a=e.interfaces[i],s=getNICSpeedString(a);s&&$("#host-hardware").append("NIC #"+(i+1)+" Speed: "+s+"<br>"),hasField(a,"interface-mtu")&&$("#host-hardware").append("NIC #"+(i+1)+" MTU: "+a["interface-mtu"][0]+"<br>")}var n=getOSString(e);if(n&&$("#host-os").append("Operating System: "+n+"<br>"),hasField(e,"host-os-kernel")&&$("#host-os").append("Kernel: "+e["host-os-kernel"][0]+"<br>"),e.administrators)for(var i=0;i<e.administrators.length;i++){var c=e.administrators[i],l="Contact #"+(i+1)+": ";if(hasField(c,"person-name")&&(l+=c["person-name"]+" "),hasField(c,"person-emails")){var d=getLinks(c["person-emails"],"mailto:");l+="("+d.join()+")"}$("#host-os").append($.trim(l)+"<br>")}hasField(e,"pshost-toolkitversion")&&$("#host-version").html(e["pshost-toolkitversion"][0]),hasField(e,"group-communities")&&$("#host-communities").html(e["group-communities"].sort().join("<br>"))}}function clearHostInfo(){activeHost=null,$("#host-name").empty(),$("#host-hardware").empty(),$("#host-os").empty(),$("#host-version").empty(),$("#host-communities").empty()}function showCommunities(){for(var e=[],t=filteredMap.getServices(),r=0;r<t.length;r++)hasField(t[r],"group-communities")&&$.merge(e,t[r]["group-communities"]);e=e.sort().unique();for(var i=$("#communities").empty(),r=0;r<e.length;r++)i.append($("<option>").val(e[r]).prop("selected",!0).text(e[r]))}function showInfoWindow(e){for(var t=[],r=e.filtered,i=0;i<r.length;i++){var o=r[i],a=null,s="",n="";if(o.host&&(a=o.host,s=getTitle(o.host),n=getHostname(o.host)),s||(s=getTitle(o)),n||(n=getHostname(o)),s&&n){s!=n&&(s+=" ("+n+")");for(var c=null,l=0;l<t.length;l++)t[l].host&&t[l].host==a?c=t[l]:t[l].hostname==n&&(c=t[l]);c?c.services.push(o):(c=t[t.push({title:s,hostname:n})-1],c.host=a,c.services=[o])}}t.sort(function(e,t){return compareHostnames(e.hostname,t.hostname)});for(var d=$("<dl>").prop("id","info-window"),p=function(e,t){var r="",i="";return hasField(e,"service-type")&&(r=e["service-type"][0].toLowerCase()),hasField(t,"service-type")&&(i=t["service-type"][0].toLowerCase()),r>i?1:i>r?-1:0},m=function(e){onInfoWindowActivate($(this).data("service")),e.preventDefault()},i=0;i<t.length;i++){var c=t[i];d.append($("<dt>").text(c.title)),c.services.sort(p);for(var l=0;l<c.services.length;l++){var o=c.services[l],v=getServiceTypeTitle(o);d.append($("<dd>").append($("<a>").prop({title:v,href:"#"}).text(v).data("service",o).click(m)))}}map.gmap("openInfoWindow",{content:d.get(0)},e)}function updateCommunities(){var e=$("#communities option").filter(":selected"),t=e.map(function(){return $(this).val()}),r=getFilteredRecords(recordMap.getServices(),filter,!0);filteredMap=new RecordMap(r);for(var i=filteredMap.getServices(),o=[],a=0;a<i.length;a++)for(var s=0;s<t.length;s++)hasField(i[a],"group-communities")&&$.inArray(t[s],i[a]["group-communities"])>=0&&o.push(i[a]);r=getFilteredRecords(o,""),filteredMap=new RecordMap(r),updateMap(),updateTree(),updateStatus()}function resetCommunities(){var e=$("#communities option").not(":selected");e.prop("selected",!0);var t=getFilteredRecords(recordMap.getServices(),filter);filteredMap=new RecordMap(t),updateMap(),updateTree(),updateStatus()}function updateMap(){map.gmap("closeInfoWindow"),updateMarkers(),zoomToFitMarkers()}function updateMarkers(){activeMarker=null;for(var e in markers){var t=markers[e];t.filtered=[];for(var r=[],i=0;i<t.services.length;i++){var o=t.services[i];$.inArray(o,filteredMap.getServices(o))>=0&&(t.filtered.push(o),r.push(o.host?getTitle(o.host):getTitle(o)))}r=r.sort(compareHostnames).unique(),1==r.length?t.setTitle(r[0]):r.length>1&&t.setTitle(r[0]+"..."),t.setVisible(t.filtered.length>0?!0:!1)}}function updateSearch(){var e=$("#search").val();if(e!=filter){try{var t=getFilteredRecords(recordMap.getServices(),e);filteredMap=new RecordMap(t),filter=e}catch(r){return void $("#search-control").addClass("error")}showCommunities(),updateMap(),updateTree(),updateStatus()}}function resetSearch(){if(filter){var e=getFilteredRecords(recordMap.getServices(),"");filteredMap=new RecordMap(e),filter="",showCommunities(),updateMap(),updateTree(),updateStatus()}}function updateStatus(){var e=filteredMap.getHosts().length,t=filteredMap.getServices().length,r=recordMap.getServices().length;$("#status").html(1==e?"Showing: "+t+" of "+r+" services on "+e+" host.":"Showing: "+t+" of "+r+" services on "+e+" hosts."),$("#loading").modal("hide")}function updateTree(){activeNode=null,updateTreeNodes(),tree.fancytree("getTree").reload(),tree.fancytree("getTree").filterNodes(function(e){return e.data.visible}),tree.fancytree("getRootNode").sortChildren(function(e,t){var r=e.isFolder(),i=t.isFolder();return r||i?!r&&i?1:r&&!i?-1:0:compareHostnames(e.data.name,t.data.name)},!0)}function updateTreeNodes(e){e||(e=treeNodes);for(var t=0,r=0;r<e.length;r++){var i=e[r];if(i.folder){var o=updateTreeNodes(i.children);i.title=i.name+'<span class="badge tree-badge">'+o+"</span>",o>0?(i.visible=!0,t+=o):i.visible=!1}else i.service&&($.inArray(i.service,filteredMap.getServices(i.service))>=0?(i.visible=!0,t++):i.visible=!1)}return t}function zoomToFitMarkers(){var e=new google.maps.LatLngBounds;for(var t in markers)markers[t].visible&&e.extend(markers[t].getPosition());e.isEmpty()||map.gmap("get","map").fitBounds(e);var r=map.gmap("get","map").getZoom();r=2>r?2:r>6?6:r,map.gmap("option","zoom",r)}var initialized=!1,recordMap=null,filteredMap=null,filter="",activeService=null,activeHost=null;$("#loading").modal("show");var mapOptions={center:new google.maps.LatLng(0,0),zoom:2,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,noClear:!0},map=initMap(mapOptions),defaultMarkerIcon={path:google.maps.SymbolPath.CIRCLE,scale:4,fillColor:"#EF706C",fillOpacity:1,strokeColor:"#E36C65",strokeWeight:1},markers={},activeMarker=null,treeNodes=initTreeNodes(),tree=initTree(treeNodes),activeNode=null;$("#communities-update").click(function(){initialized&&updateCommunities()}),$("#communities-reset").click(function(){initialized&&resetCommunities()}),$("#search-update").click(function(){initialized&&updateSearch()}),$("#search-reset").click(function(){initialized&&resetSearch()}),$("#search").keydown(function(e){initialized&&($("#search-control").removeClass("error"),13==e.keyCode&&(updateSearch(),e.preventDefault()))}),$.getJSON("query?filter=default&geocode=true&remap=true",function(e){initialize(e)});