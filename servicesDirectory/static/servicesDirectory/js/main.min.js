function initMap(e){var t=$("#map-canvas").gmap(e);return t}function initTree(e){var t=$("#tree").fancytree({activate:function(e,t){nodeActivate(t.node)},extensions:["filter"],filter:{mode:"hide"},source:e});return t}function initTreeNodes(){var e=[];for(var t in serviceMap){var r=[];if(serviceMap[t].types)for(var i in serviceMap[t].types){var o=serviceMap[t].types[i].title,s=r[r.push({folder:!0,name:o,title:o,tooltip:o,type:i,visible:!0})-1];s.children=[]}var a=serviceMap[t].title,n=e[e.push({folder:!0,name:a,title:a,tooltip:a,type:t,visible:!0})-1];n.children=r}return e}function initialize(e){try{recordMap=new RecordMap(e,!0);for(var t=recordMap.getServices(),r=0;r<t.length;r++)addServiceNode(t[r]),addServiceMarker(t[r]);var i=getFilteredRecords(t,"");filteredMap=new RecordMap(i),updateCommunities(),updateMap(),updateTree(),updateStatus(),showStats(),hashChange(),hideLoading(),inputLocks=[]}catch(o){console.log(o),showError()}}function addServiceMarker(e){var t=getLatLng(e);if(t){var r=null;markers[t]?r=markers[t]:(r=map.gmap("addMarker",{position:t,icon:defaultMarkerIcon,optimized:!1}).click(function(){markerActivate(this)}).get(0),r.filtered=[],r.services=[],markers[t]=r),r.services.push(e)}}function addServiceNode(e){var t="",r="";hasField(e,"service-type")&&(t=e["service-type"][0]),hasField(e,t+"-type")&&(r=e[t+"-type"][0]);var i=getHostname(e),o=getTitle(e);if(o&&i){o=i!=o?"<b>"+i+"</b> ("+o+")":"<b>"+i+"</b>";for(var s=null,a=null,n=0;n<treeNodes.length;n++)if(treeNodes[n].type==t.toLowerCase()){if(s=treeNodes[n],r)for(var c=0;c<s.children.length;c++)if(s.children[c].type==r){a=s.children[c];break}break}!s&&t&&(s=treeNodes[treeNodes.push({folder:!0,name:t,title:t,tooltip:t,type:t,visible:!0})-1],s.children=[]),!a&&r&&(a=s.children[s.children.push({folder:!0,name:r,title:r,tooltip:r,type:r,visible:!0})-1],a.children=[]);var p={name:i,title:o,tooltip:i,type:"service",visible:!0};p.service=e,r?a.children.push(p):t?s.children.push(p):treeNodes.push(p)}}function communitiesUpdate(){var e=inputLocks.push("communitiesUpdate")-1,t=$("#communities option"),r=t.filter(":selected").map(function(){return $(this).val()}).get();if(r.length==communities.length)communitiesReset();else if(r.length!=filter.communities.length||!r.equals(filter.communities)){var i=getFilteredRecords(recordMap.getServices(),filter.search,!0);filteredMap=new RecordMap(i);for(var o=filteredMap.getServices(),s=[],a=0;a<o.length;a++)for(var n=0;n<r.length;n++)hasField(o[a],"group-communities")&&$.inArray(r[n],o[a]["group-communities"])>=0&&s.push(o[a]);i=getFilteredRecords(s,""),filteredMap=new RecordMap(i),filter.communities=r,updateHash(),updateMap(),updateTree(),updateStatus()}inputLocks.splice(e,1)}function communitiesReset(){var e=inputLocks.push("communitiesReset")-1,t=$("#communities option"),r=t.not(":selected");if(filter.communities.length!=communities.length){var i=getFilteredRecords(recordMap.getServices(),filter.search);filteredMap=new RecordMap(i),filter.communities=communities,updateHash(),updateMap(),updateTree(),updateStatus()}r.prop("selected",!0),inputLocks.splice(e,1)}function hashChange(){var e=inputLocks.push("hashChange")-1,t=queryToHash(window.location.hash);if(t.search?($("#search").val(t.search),searchUpdate()):searchReset(),t.communities){var r=$("#communities option");r.each(function(e,r){var i=$(r);$.inArray(i.val(),t.communities)>=0?i.prop("selected",!0):i.prop("selected",!1)}),communitiesUpdate()}else communitiesReset();if(t.uri){for(var i=null,o=recordMap.getServices(),s=0;s<o.length;s++)if(o[s].uri==t.uri){i=o[s];break}if(i){var a=getLatLng(i);a&&markers[a]?markerActivate(markers[a]):map.gmap("closeInfoWindow"),showServiceInfo(i),showHostInfo(i.host),updateHash()}}else map.gmap("closeInfoWindow"),clearServiceInfo(),clearHostInfo();inputLocks.splice(e,1)}function rawOutputUpdate(){showRawOutput(activeService)}function infoWindowActivate(e){showServiceInfo(e),showHostInfo(e.host),updateHash()}function markerActivate(e){activeMarker=e,e.services&&showInfoWindow(e)}function nodeActivate(e){if(activeNode=e,e.data.service){var t=e.data.service,r=getLatLng(t);r&&markers[r]?markerActivate(markers[r]):map.gmap("closeInfoWindow"),showServiceInfo(t),showHostInfo(t.host),updateHash()}}function searchUpdate(){var e=inputLocks.push("searchUpdate")-1,t=$("#search").val();if(t!=filter.search)try{var r=getFilteredRecords(recordMap.getServices(),t);filteredMap=new RecordMap(r),filter.search=t,updateCommunities(),updateHash(),updateMap(),updateTree(),updateStatus()}catch(i){$("#search-control").addClass("error")}inputLocks.splice(e,1)}function searchReset(){var e=inputLocks.push("searchReset")-1;if(filter.search){var t=getFilteredRecords(recordMap.getServices(),"");filteredMap=new RecordMap(t),filter.search="",updateCommunities(),updateHash(),updateMap(),updateTree(),updateStatus()}inputLocks.splice(e,1)}function showServiceInfo(e){if(clearServiceInfo(),e){activeService=e,hasField(e,"service-name")&&$("#service-name").html(e["service-name"][0]);var t=getLinks(getHostnames(e),"http://","/");$("#service-locator").html(t.join("<br>"));var r=getLocationString(e),i=getLatLngString(e);$("#service-location").html(r+'<br><div class="muted">'+i+"</div"),hasField(e,"group-communities")&&$("#service-communities").html(e["group-communities"].sort().join("<br>")),hasField(e,"service-version")&&$("#service-version").html(e["service-version"][0]),showCustomInfo(e)}}function showCustomInfo(e){var t=getServiceMapping(e);if(t&&t.custom&&t.custom.type){var r=t.custom;if($("#service-custom-header").text(r.title?r.title:"Custom"),"cli"==r.type){var i=getCommandLine(e,r.formats);$("#service-custom").html(i.join("<br>"))}else if("ma"==r.type||"mp"==r.type){var o=getLinks(getAddresses(e));$("#service-custom").html(o.join("<br>"))}$("#service-custom-header").show(),$("#service-custom").parent().show()}else $("#service-custom-header").hide(),$("#service-custom").parent().hide()}function clearServiceInfo(){activeService=null,$("#service-name").empty(),$("#service-location").empty(),$("#service-locator").empty(),$("#service-communities").empty(),$("#service-version").empty(),$("#service-custom").empty()}function showHostInfo(e){if(clearHostInfo(),e){if(activeHost=e,hasField(e,"host-name")){var t=getLinks(getHostnames(e),"http://","/");$("#host-name").html(t.join("<br>"))}for(var r=getProcessorStrings(e),i=0;i<r.length;i++)$("#host-hardware").append("Processor #"+(i+1)+": "+r[i]+"<br>");var o=getMemoryString(e);if(o&&$("#host-hardware").append("Memory: "+o+"<br>"),e.interfaces)for(var i=0;i<e.interfaces.length;i++){var s=e.interfaces[i],a=getNICSpeedString(s);a&&$("#host-hardware").append("NIC #"+(i+1)+" Speed: "+a+"<br>"),hasField(s,"interface-mtu")&&$("#host-hardware").append("NIC #"+(i+1)+" MTU: "+s["interface-mtu"][0]+"<br>")}var n=getOSString(e);if(n&&$("#host-os").append("Operating System: "+n+"<br>"),hasField(e,"host-os-kernel")&&$("#host-os").append("Kernel: "+e["host-os-kernel"][0]+"<br>"),e.administrators)for(var i=0;i<e.administrators.length;i++){var c=e.administrators[i],p="Contact #"+(i+1)+": ";if(hasField(c,"person-name")&&(p+=c["person-name"]+" "),hasField(c,"person-emails")){var d=getLinks(c["person-emails"],"mailto:");p+="("+d.join()+")"}$("#host-os").append($.trim(p)+"<br>")}hasField(e,"pshost-toolkitversion")&&$("#host-version").html(e["pshost-toolkitversion"][0]),hasField(e,"group-communities")&&$("#host-communities").html(e["group-communities"].sort().join("<br>"))}}function clearHostInfo(){activeHost=null,$("#host-name").empty(),$("#host-hardware").empty(),$("#host-os").empty(),$("#host-version").empty(),$("#host-communities").empty()}function showStats(){var e=$("#stats-table tbody"),t=null,r=0,i=0,o=0,s=0;for(var a in recordMap.records){var n=recordMap.records[a],c=0,p=0,d=0,l=0;n.service&&(c=n.service.length),n.host&&(p=n.host.length),n["interface"]&&(d=n["interface"].length),n.person&&(l=n.person.length),r+=c,i+=p,o+=d,s+=l,t=$("<tr>").appendTo(e),$("<td>").text(getHostnameFromURI(a)).appendTo(t),$("<td>").text(c).appendTo(t),$("<td>").text(p).appendTo(t),$("<td>").text(d).appendTo(t),$("<td>").text(l).appendTo(t)}t=$("<tr>").appendTo(e),$("<td>").append($("<strong>").text("Total")).appendTo(t),$("<td>").text(r).appendTo(t),$("<td>").text(i).appendTo(t),$("<td>").text(o).appendTo(t),$("<td>").text(s).appendTo(t)}function showRawOutput(e){var t={};if(e){records=getLinkedRecords(e),records.push(e),ignoredFields=["administrators","host","hosts","interfaces","services"];for(var r=0;r<records.length;r++){var i=records[r],o={};for(var s in i)-1==$.inArray(s,ignoredFields)&&(o[s]=i[s]);var a=i.type[0];t[a]?t[a].push(o):t[a]=[o]}}$("#raw-output").val($.toJSON(t))}function showInfoWindow(e){for(var t=[],r=e.filtered,i=0;i<r.length;i++){var o=r[i],s=null,a="",n="";if(o.host&&(s=o.host,a=getTitle(o.host),n=getHostname(o.host)),a||(a=getTitle(o)),n||(n=getHostname(o)),a&&n){a!=n&&(a+=" ("+n+")");for(var c=null,p=0;p<t.length;p++)t[p].host&&t[p].host==s?c=t[p]:t[p].hostname==n&&(c=t[p]);c?c.services.push(o):(c=t[t.push({title:a,hostname:n})-1],c.host=s,c.services=[o])}}t.sort(function(e,t){return compareHostnames(e.hostname,t.hostname)});for(var d=$("<div>").prop("id","info-window"),l=$("<dl>").prop("id","info-window-content").appendTo(d),u=function(e,t){var r="",i="";return hasField(e,"service-type")&&(r=e["service-type"][0].toLowerCase()),hasField(t,"service-type")&&(i=t["service-type"][0].toLowerCase()),r>i?1:i>r?-1:0},m=function(e){infoWindowActivate($(this).data("service")),e.preventDefault()},i=0;i<t.length;i++){var c=t[i];l.append($("<dt>").text(c.title)),c.services.sort(u);for(var p=0;p<c.services.length;p++){var o=c.services[p],h=getServiceTypeTitle(o);l.append($("<dd>").append($("<a>").prop({title:h,href:"#"}).text(h).data("service",o).click(m)))}}map.gmap("openInfoWindow",{content:d.get(0)},e)}function showError(){$(".modal").modal("hide"),$("#error").modal("show")}function hideError(){$("#error").modal("hide"),$(".modal-backdrop").remove()}function showLoading(){$(".modal").modal("hide"),$("#loading").modal("show")}function hideLoading(){$("#loading").modal("hide"),$(".modal-backdrop").remove()}function updateCommunities(){communities=[];for(var e=filteredMap.getServices(),t=0;t<e.length;t++)hasField(e[t],"group-communities")&&$.merge(communities,e[t]["group-communities"]);communities=communities.sort().unique();for(var r=$("#communities").empty(),t=0;t<communities.length;t++)r.append($("<option>").val(communities[t]).prop("selected",!0).text(communities[t]));filter.communities=communities}function updateHash(){var e={};filter.search&&(e.search=filter.search),filter.communities.length!=communities.length&&(e.communities=filter.communities),activeService&&(e.uri=activeService.uri),ignoreHashChanges++,window.location.hash=hashToQuery(e)}function updateMap(){map.gmap("closeInfoWindow"),updateMarkers(),zoomToFitMarkers()}function updateMarkers(){activeMarker=null;for(var e in markers){var t=markers[e];t.filtered=[];for(var r=[],i=0;i<t.services.length;i++){var o=t.services[i];$.inArray(o,filteredMap.getServices(o))>=0&&(t.filtered.push(o),r.push(o.host?getTitle(o.host):getTitle(o)))}r=r.sort(compareHostnames).unique(),1==r.length?t.setTitle(r[0]):r.length>1&&t.setTitle(r[0]+"..."),t.setVisible(t.filtered.length>0?!0:!1)}}function updateTree(){activeNode=null,updateTreeNodes(),tree.fancytree("getTree").reload(),tree.fancytree("getTree").filterNodes(function(e){return e.data.visible}),tree.fancytree("getRootNode").sortChildren(function(e,t){var r=e.isFolder(),i=t.isFolder();return r||i?!r&&i?1:r&&!i?-1:0:compareHostnames(e.data.name,t.data.name)},!0)}function updateTreeNodes(e){e||(e=treeNodes);for(var t=0,r=0;r<e.length;r++){var i=e[r];if(i.folder){var o=updateTreeNodes(i.children);i.title=i.name+'<span class="badge tree-badge">'+o+"</span>",o>0?(i.visible=!0,t+=o):i.visible=!1}else i.service&&($.inArray(i.service,filteredMap.getServices(i.service))>=0?(i.visible=!0,t++):i.visible=!1)}return t}function updateStatus(){var e=filteredMap.getHosts().length,t=filteredMap.getServices().length,r=recordMap.getServices().length;$("#status").html(1==e?"Showing: "+t+" of "+r+" services on "+e+" host.":"Showing: "+t+" of "+r+" services on "+e+" hosts.")}function zoomToFitMarkers(){var e=new google.maps.LatLngBounds;for(var t in markers)markers[t].visible&&(t=markers[t].getPosition(),Math.abs(t.lat())<=85&&e.extend(t));e.isEmpty()||map.gmap("get","map").fitBounds(e);var r=map.gmap("get","map").getZoom();r=2>r?2:r>6?6:r,map.gmap("option","zoom",r)}var inputLocks=["init"],ignoreHashChanges=0,recordMap=null,filteredMap=null,communities,filter={search:"",communities:[]},activeService=null,activeHost=null;showLoading();var mapOptions={center:new google.maps.LatLng(0,0),zoom:2,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,noClear:!0},map=initMap(mapOptions),defaultMarkerIcon={path:google.maps.SymbolPath.CIRCLE,scale:4,fillColor:"#EF706C",fillOpacity:1,strokeColor:"#E36C65",strokeWeight:1},markers={},activeMarker=null,treeNodes=initTreeNodes(),tree=initTree(treeNodes),activeNode=null;$(window).on("hashchange",function(){0===inputLocks.length&&0===ignoreHashChanges?hashChange():ignoreHashChanges--}),$("#communities-update").click(function(){0===inputLocks.length&&communitiesUpdate()}),$("#communities-reset").click(function(){0===inputLocks.length&&communitiesReset()}),$("#raw-output-update").click(function(){0===inputLocks.length&&rawOutputUpdate()}),$("#search-update").click(function(){0===inputLocks.length&&searchUpdate()}),$("#search-reset").click(function(){0===inputLocks.length&&searchReset()}),$("#search").keydown(function(e){$("#search-control").removeClass("error"),0===inputLocks.length&&13==e.keyCode&&(searchUpdate(),e.preventDefault())}),$.getJSON("records?filter=default&geocode=true&remap=true",initialize).fail(showError);