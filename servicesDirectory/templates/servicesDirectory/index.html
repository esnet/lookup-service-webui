{% extends "servicesDirectory/base.html" %}

{% load staticfiles %}

{% block description %}Lookup Service Directory{% endblock %}

{% block title %}Lookup Service Directory{% endblock %}

{% block assets_pre %}
	<link rel="stylesheet" type="text/css" href="{% static "css/dynatree/skin-lion/ui.dynatree.css" %}">
	<style type="text/css">
		.map-canvas { height: 75%; }
		.map-canvas label { width: auto; display: inline; }
		.map-canvas img { max-width: none; }
		.tree { height: 75%; }
	</style>
{% endblock %}

{% block header %}<h3>perfSONAR Global Service and Data View</h3>{% endblock %}

{% block content %}
		<div class="row-fluid fill">
			<div class="span3 fill" id="browser">
				<h4 class="content-header">Browser</h4>
				<div class="content">
					<div class="tree" id="tree"></div>
				</div>
			</div>
			<div class="span5 separator-left fill" id="map">
				<h4 class="content-header">Service Map</h4>
				<div class="content">
					<div class="map-canvas" id="map-canvas"></div>
				</div>
			</div>
			<div class="span4 separator-left fill" id="info">
				<h4 class="content-header">Service Information</h4>
				<div class="content">
					<table class="table table-bordered">
						<tr>
							<td>Service Name</td>
							<td id="service-name">{{ service_name|join:", " }}</td>
						</tr><tr>
							<td>Address</td>
							<td id="service-locator">{{ service_locator|join:", " }}</td>
						</tr><tr>
							<td>Geographic Location</td>
							<td id="service-location">{{ location }}</td>
						</tr><tr>
							<td>Communities</td>
							<td id="group-communities">{{ group_communities|join:", " }}</td>
						</tr><tr>
							<td>Example Command-Line</td>
							<td id="command-line">{{ command_line }}</td>
						</tr><tr>
							<td>Actions</td>
							<td id="psservice-eventtypes">{{ actions|join:", " }}</td>
						</tr>
					</table>
				</div>
			</div>
		</div>
{% endblock %}
{% block assets_post %}
	<script type="text/javascript" src="{% static "js/jquery.ui.js" %}"></script>
	<script type="text/javascript" src="{% static "js/jquery.dynatree.js" %}"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDM9EqM1k7MiJnslQpropqmvUbwXPhEI1U&sensor=false"></script>
	<script type="text/javascript" src="{% static "js/jquery.ui.map.js" %}"></script>
	<script type="text/javascript">
		var map = $("#map-canvas").gmap({
			"center": new google.maps.LatLng(0, 0),
			"zoom": 2,
			"streetViewControl": false,
			"mapTypeId": google.maps.MapTypeId.ROADMAP,
			"noClear": true
		});
		var geocoder = new google.maps.Geocoder();
		geocoder.geocode({ "address": "United States" }, function(results, status)
		{
			if ((status == google.maps.GeocoderStatus.OK) && results[0].geometry && results[0].geometry.viewport)
				map.gmap("get", "map").fitBounds(results[0].geometry.viewport);
		});
		var hosts = [];
		var interfaces = [];
		var services = [];
		var treeData = [
			{ "title": "BWCTL", "isFolder": true, "children": [] },
			{ "title": "MA", "isFolder": true, "children": [] },
			{ "title": "NDT", "isFolder": true, "children": [] },
			{ "title": "NPAD", "isFolder": true, "children": [] },
			{ "title": "OWAMP", "isFolder": true, "children": [] },
			{ "title": "Ping", "isFolder": true, "children": [] },
			{ "title": "Traceroute", "isFolder": true, "children": [] },
		];
		var tree = $("#tree").dynatree({ "onActivate": function(node)
		{
			if (("marker" in node.data) && (node.data["marker"] != null))
				map.gmap("openInfoWindow", { "content": markerData[node.data["marker"][0].getPosition()] }, node.data["marker"][0]);
			else
				map.gmap("closeInfoWindow");
		}, "children": treeData });
		var markerData = {};
		var markers = {};
		$.getJSON(window.location.href + "query?filter=default&geocode=true", function(data)
		{
			for (var i = 0 ; i < data.length ; i++)
			{
				var record = data[i];
				var marker = null;
				var latlng = null;
				if ((record["location-latitude"]) && (record["location-longitude"]))
					latlng = new google.maps.LatLng(record["location-latitude"], record["location-longitude"]);
				if (latlng != null)
				{
					for (var key in markers)
					{
						if (key == latlng)
						{
							marker = markers[latlng];
							break;
						}
					}
					if (marker != null)
					{
						markerData[latlng] = markerData[latlng] + "<br />" + record["type"] + ": " + record[record["type"] + "-name"];
					}
					else
					{
						marker = map.gmap("addMarker", { "position": latlng });
						markerData[latlng] = record["type"] + ": " + record[record["type"] + "-name"];
						marker.click(function()
						{
							map.gmap("openInfoWindow", { "content": markerData[this.getPosition()] }, this);
						});
						markers[latlng] = marker;
					}
				}
				if (record["type"][0] == "host")
				{
					hosts.push(record);
				}
				else if (record["type"][0] == "interface")
				{
					interfaces.push(record);
				}
				else if (record["type"][0] == "service")
				{
					services.push(record);
					var found = false;
					for (var j = 0 ; j < treeData.length ; j++)
					{
						if (treeData[j]["title"].toLowerCase() == record["service-type"][0].toLowerCase())
						{
							treeData[j]["children"].push({ "title": record["service-name"][0], "marker": marker });
							found = true;
							break;
						}
					}
					if (!found)
						treeData.push({ "title": record["service-type"][0], "isFolder": true, "children": [ { "title": record["service-name"][0], "marker": marker } ] });
				}
			}
			$("#tree").dynatree("getTree").reload()
			$("#tree").dynatree("getRoot").sortChildren(null, true);
		});
	</script>
{% endblock %}
